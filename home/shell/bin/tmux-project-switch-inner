#!/usr/bin/env sh
set -eo pipefail

if [[ -z "$TMUX_WORKSPACE" ]]; then
    echo 'Environment variable TMUX_WORKSPACE is not set'
    exit 1
fi

selected="$(find ~/workspaces/$TMUX_WORKSPACE -maxdepth 1 -mindepth 1 -type d -printf '%P\n' | fzf --exit-0)"
project="$(echo $selected | tr ' .' _)"
session="workspace/$TMUX_WORKSPACE/$project"
directory="$HOME/workspaces/$TMUX_WORKSPACE/$project"

if ! tmux has-session -t "$session" 2> /dev/null; then
    tmux new-session -ds "$session" -c "$directory"
    tmux set-environment -t "$session" TMUX_WORKSPACE "$TMUX_WORKSPACE"
fi

if [[ -z "$TMUX" ]]; then
    tmux attach-session -t "$session"
else
    tmux switch-client -t "$session"
fi
